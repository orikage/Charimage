CoC7版キャラクターシート画像化Webアプリ - アーキテクチャ設計
1. 全体像
このアプリケーションは、ユーザーのブラウザ上で全ての処理が完結するシングルページアプリケーション (SPA) として設計します。サーバーサイドの処理は不要で、静的なHTML/CSS/JavaScriptファイルをホスティングするだけで運用可能です。

コード スニペット

graph TD
    A[ユーザーのブラウザ] --> B(Webサーバーから静的ファイルをダウンロード)
    B --> C(HTML/CSS/JavaScript)
    C -- キャラシテキスト入力 --> D{JavaScriptロジック}
    D -- テキスト解析 --> E[データモデル]
    E -- HTML要素生成 --> F[DOM構造]
    F -- CSS適用 --> G[表示上のキャラシ]
    G -- html2canvasで画像化 --> H[Canvas]
    H -- PNGデータ生成 --> I[画像ファイル（PNG）]
    I --> J(ダウンロード)
    J --> A
2. 主要コンポーネント
各コンポーネントの役割と、それに使用する技術要素を詳しく見ていきましょう。

2.1. HTML (View Structure)
役割: アプリケーションの骨格と、ユーザーインターフェースの要素を定義します。

主な要素:

入力エリア: キャラクターシートのテキストデータを貼り付けるための <textarea> 要素。

操作ボタン: 「画像生成」などの <button> 要素。

プレビューエリア: 生成された画像を一時的に表示するための <img> または <canvas> 要素。

ダウンロードリンク: 生成された画像をダウンロードするための <a> 要素。

表示用コンテナ: キャラクターシートの情報を動的に構築し、html2canvas で画像化する元となる <div> 要素。この要素は普段は非表示にしておき、画像生成の際にのみ利用することも検討します。

エラーメッセージ表示領域: 入力エラーや処理中のメッセージを表示する領域。

2.2. CSS (Styling & Layout)
役割: HTML要素の見た目を整え、縦長のキャラクターシートレイアウトを実現します。

主要な考慮点:

リセットCSS: ブラウザ間の表示の差異を吸収するために利用。

セクション分け: キャラクター情報、能力値、技能、所持品など、各セクションを明確に区切るスタイル。

フォント: 可読性の高いWebフォント（Google Fontsなど）の利用も検討。

縦長レイアウト: FlexboxやGrid Layoutを使用して、情報を効率的かつ美しく縦方向に配置します。

レスポンシブデザイン: スマートフォンからの利用も考慮し、画面幅に応じたレイアウト調整（初期優先度は低）。

プリントフレンドリー: html2canvas で画像化する際の表示崩れを防ぐため、print メディアクエリの利用や、特定の要素の非表示・表示調整も検討。

2.3. JavaScript (Core Logic)
これがアプリケーションの心臓部となります。

2.3.1. イベントハンドリング
役割: ユーザーの操作（ボタンクリックなど）を検知し、適切な処理を呼び出します。

イベント: click イベント（「画像生成」ボタン）、input イベント（テキストエリアの入力監視）。

2.3.2. データパーサー (Text Parser)
役割: 入力されたCoC7版キャラクターシートのテキストデータを解析し、構造化されたデータモデルに変換します。

実装方法:

正規表現 (RegExp): 各情報（能力値、技能、所持品など）のパターンを定義し、テキストから抽出します。

文字列操作: split(), substring(), indexOf() などのメソッドを組み合わせてデータを分割・抽出します。

データモデルの出力形式: JavaScriptオブジェクト（JSONライクな構造）として整形します。例:

JavaScript

{
  characterName: "ジョン・ドゥ",
  plName: "プレイヤーA",
  attributes: {
    STR: 60,
    CON: 50,
    DEX: 70,
    // ... 他の能力値
  },
  skills: [
    { name: "言いくるめ", value: 65 },
    { name: "回避", value: 70 },
    // ... 他の技能
  ],
  weapons: [
    { name: "9mmオートマチック", damage: "1d10", range: "15m", attacks: "3" }
  ],
  // ... その他の情報
}
2.3.3. レンダリングエンジン (View Renderer)
役割: データパーサーが生成したデータモデルに基づき、キャラクターシートのHTML構造を動的に生成し、DOMに挿入します。

実装方法:

DOM操作: document.createElement(), appendChild(), textContent などを直接使用。

テンプレートリテラル: JavaScriptのバッククォート (     ) を使って、HTML文字列を効率的に生成し、innerHTML で挿入。

CSSクラスの適用: スタイルを適用するための適切なCSSクラスを要素に付与します。

2.3.4. 画像ジェネレーター (Image Generator)
役割: レンダリングされたキャラクターシートのHTML要素を画像データに変換します。

使用ライブラリ: html2canvas

指定したHTML要素をCanvas要素に描画します。

CanvasからPNG形式のデータURLを生成します。

2.3.5. ダウンロードマネージャー (Download Manager)
役割: 生成されたPNGデータURLを、ユーザーがダウンロードできるファイルとして提供します。

実装方法:

<a> 要素を動的に作成し、href 属性にデータURLを設定、download 属性にファイル名を設定して、JavaScriptから click() メソッドを呼び出します。

2.3.6. エラーハンドリング & UX
役割: 不正な入力や処理中の問題に対して、ユーザーに分かりやすいフィードバックを提供します。

実装内容:

テキスト解析失敗時のエラーメッセージ表示。

画像生成中のローディングインジケーター表示。

成功メッセージや、ダウンロード完了の通知。

3. データフロー
ユーザーがWebページにアクセスし、HTML/CSS/JavaScriptをロード。

ユーザーがテキストエリアにCoC7版キャラシテキストを貼り付け、「画像生成」ボタンをクリック。

JavaScriptのイベントハンドラが起動。

データパーサーが入力テキストを解析し、構造化されたキャラクターデータオブジェクトを生成。

レンダリングエンジンがそのデータオブジェクトに基づき、画像化用の非表示または表示領域にキャラクターシートのHTML要素を構築。

画像ジェネレーター (html2canvas) が、構築されたHTML要素を読み取り、Canvasに描画。

CanvasからPNG形式の画像データURLを生成。

生成された画像がプレビューエリアに表示される。

ダウンロードマネージャーがダウンロードリンク（ボタン）を有効にし、ユーザーがクリックすると画像がダウンロードされる。

エラー発生時には、適切なエラーメッセージが表示される。

4. 開発時の注意点
テキスト解析の堅牢性: CoC7版のテキストフォーマットは非常に多様な記述がされうるため、正規表現の設計が非常に重要になります。網羅性と堅牢性を高めるために、複数のパターンや例外処理を考慮する必要があります。

html2canvas の制限: html2canvas はブラウザのDOMを再現して描画するため、一部のCSSプロパティや複雑なレイアウト（特に外部フォントの読み込みタイミングなど）で予期せぬ表示崩れが発生することがあります。テストを繰り返して調整が必要です。

パフォーマンス: 大量の技能や情報を持つキャラクターシートの場合、DOMの生成や html2canvas の処理に時間がかかることがあります。非同期処理やローディング表示でユーザー体験を損なわない工夫が必要です。